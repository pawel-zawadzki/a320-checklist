<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A320neo Checklist - MSFS 2024</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'airbus-blue': '#0066cc',
                        'airbus-dark': '#1a1a2e',
                        'cockpit-green': '#00cc33'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- Header -->
    <header class="bg-airbus-blue dark:bg-airbus-dark text-white p-4 shadow-lg">
        <div class="flex justify-between items-center max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-white hover:text-gray-200 transition-colors">
                    <span class="text-lg">‚Üê</span>
                </a>
                <h1 class="text-lg font-bold">A320neo FBW</h1>
            </div>
            <div class="flex items-center space-x-2">
                <button id="themeToggle" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition-colors">
                    <span class="text-sm">üåô</span>
                </button>
                <button id="resetAll" class="px-3 py-1 text-xs bg-red-500 hover:bg-red-600 rounded transition-colors">
                    Reset
                </button>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="bg-white dark:bg-gray-800 px-4 py-2 shadow">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium">Progress</span>
                <span id="progressText" class="text-sm text-gray-600 dark:text-gray-400">1/22</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div id="progressBar"
                    class="bg-airbus-blue dark:bg-cockpit-green h-2 rounded-full transition-all duration-300"
                    style="width: 4.5%"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-md mx-auto p-4 min-h-screen">
        <!-- Stage Title -->
        <div class="mb-6">
            <h2 id="stageTitle" class="text-2xl font-bold text-airbus-blue dark:text-cockpit-green mb-2"></h2>
            <p class="text-sm text-gray-600 dark:text-gray-400">MSFS 2024 ‚Ä¢ SimBrief/FBW Method</p>
        </div>

        <!-- Checklist Items -->
        <div id="checklistContainer" class="space-y-3 mb-8">
            <!-- Items will be populated by JavaScript -->
        </div>

        <!-- Stage Completion -->
        <div id="stageComplete"
            class="hidden mb-6 p-4 bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span class="text-green-600 dark:text-green-400 mr-2">‚úÖ</span>
                    <span class="font-medium text-green-800 dark:text-green-300">Stage Complete!</span>
                </div>
                <div id="autoAdvanceIndicator"
                    class="hidden flex items-center text-sm text-green-700 dark:text-green-300">
                    <span class="mr-2">Next stage in</span>
                    <span id="countdownTimer" class="font-mono font-bold text-lg">2</span>
                    <button id="cancelAutoAdvance"
                        class="ml-3 px-2 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div
            class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <button id="prevBtn"
                    class="px-6 py-3 bg-gray-500 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    ‚Üê Previous
                </button>
                <span id="stageCounter" class="text-sm text-gray-600 dark:text-gray-400 font-medium"></span>
                <button id="nextBtn"
                    class="px-6 py-3 bg-airbus-blue dark:bg-cockpit-green text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    Next ‚Üí
                </button>
            </div>
        </div>

        <!-- Bottom spacing for fixed nav -->
        <div class="h-24"></div>
    </main>

    <script>
        // Checklist Data
        const checklistData = [
            {
                title: "Flight Deck Prep",
                items: [
                    { item: "Wipers L/R", check: "OFF" },
                    { item: "Parking Brake", check: "ON" },
                    { item: "Throttle", check: "IDLE" },
                    { item: "Reverse Thrust", check: "STOWED" },
                    { item: "Speed Brakes", check: "RETRACTED & DISARMED" },
                    { item: "Flaps", check: "UP" },
                    { item: "WX Radar", check: "OFF" },
                    { item: "Gear Lever", check: "DOWN" },
                    { item: "Battery Voltage", check: "‚â• 25V" },
                    { item: "Battery 1 & 2", check: "ON" },
                    { item: "If < 25V", check: "EXT PWR ON" },
                    { item: "APU Fire Test", check: "TEST" },
                    { item: "APU Master", check: "ON" },
                    { item: "APU Start", check: "ON" },
                    { item: "IRS 1, 2, 3", check: "NAV" },
                    { item: "Crew Supply", check: "ON" },
                    { item: "Strobe Lights", check: "AUTO" },
                    { item: "NAV & LOGO Lights", check: "1 or 2" },
                    { item: "Seatbelt Sign", check: "ON (after fueling)" },
                    { item: "No Smoking Sign", check: "AUTO" },
                    { item: "EMER Exit Light", check: "ARM" },
                    { item: "APU Bleed", check: "ON" },
                    { item: "Air Conditioning", check: "As required" }
                ]
            },
            {
                title: "MCDU ‚Äì INIT A",
                items: [
                    { item: "INIT REQUEST", check: "EXECUTE" },
                    { item: "Clear Messages", check: "‚Äî" },
                    { item: "FLT NBR", check: "SET" }
                ]
            },
            {
                title: "MCDU ‚Äì INIT B",
                items: [
                    { item: "ZFW/ZFWCG", check: "SELECT + INSERT" },
                    { item: "Fuel Planning", check: "SELECT" }
                ]
            },
            {
                title: "MCDU ‚Äì F-PLN",
                items: [
                    { item: "DEP RWY/SID/TRANS", check: "SET" },
                    { item: "INSERT", check: "SELECT" },
                    { item: "ARR RWY/STAR/TRANS", check: "SET" },
                    { item: "INSERT", check: "SELECT" },
                    { item: "Clear Discontinuities", check: "‚Äî" },
                    { item: "SEC F-PLN", check: "COPY/INSERT" }
                ]
            },
            {
                title: "MCDU ‚Äì RAD NAV",
                items: [
                    { item: "RAD NAV", check: "SET" }
                ]
            },
            {
                title: "MCDU ‚Äì PERF",
                items: [
                    { item: "TRANS ALT", check: "SET" },
                    { item: "FLAPS/THS", check: "SET" },
                    { item: "FLEX TO TEMP", check: "SET" },
                    { item: "V1, Vr, V2", check: "SELECT + INSERT" }
                ]
            },
            {
                title: "Final Flight Deck Prep",
                items: [
                    { item: "All white lights", check: "OFF" },
                    { item: "Fuel Pumps", check: "ON" },
                    { item: "EXT PWR", check: "OFF" },
                    { item: "QNH", check: "SET" },
                    { item: "FD", check: "ON" },
                    { item: "CSTR", check: "ON" },
                    { item: "TCAS", check: "SET" }
                ]
            },
            {
                title: "Pushback",
                items: [
                    { item: "Beacon", check: "ON" },
                    { item: "Request Pushback", check: "‚Äî" },
                    { item: "Parking Brake", check: "OFF" }
                ]
            },
            {
                title: "Engine Start",
                items: [
                    { item: "Mode Selector", check: "IGN/START" },
                    { item: "ENG Master 2", check: "ON" },
                    { item: "N1 (ENG 2)", check: "~19.5%" },
                    { item: "ENG Master 1", check: "ON" },
                    { item: "N1 (ENG 1)", check: "~19.5%" }
                ]
            },
            {
                title: "After Engine Start",
                items: [
                    { item: "Parking Brake", check: "ON" },
                    { item: "Mode Selector", check: "NORM" },
                    { item: "Speed Brakes", check: "ARMED" },
                    { item: "Flaps", check: "SET (e.g. 1)" },
                    { item: "Trim", check: "SET" },
                    { item: "Rudder Trim", check: "RESET" },
                    { item: "APU Bleed", check: "OFF" },
                    { item: "APU Master", check: "OFF" },
                    { item: "Anti-Ice", check: "As required" },
                    { item: "Auto Brake", check: "MAX" },
                    { item: "Flight Controls", check: "CHECK" }
                ]
            },
            {
                title: "Taxi",
                items: [
                    { item: "Nose Light", check: "TAXI" },
                    { item: "RWY Turnoff Lights", check: "ON (if req)" },
                    { item: "Parking Brake", check: "OFF" },
                    { item: "Brakes", check: "CHECK" }
                ]
            },
            {
                title: "Holding Short",
                items: [
                    { item: "PWS", check: "AUTO" },
                    { item: "WX Radar", check: "1 or 2" },
                    { item: "TCAS", check: "TARA" },
                    { item: "T.O Config", check: "TEST" },
                    { item: "Landing Lights L/R", check: "ON" },
                    { item: "Nose Light", check: "T.O" }
                ]
            },
            {
                title: "Takeoff",
                items: [
                    { item: "Brakes", check: "HOLD" },
                    { item: "N1", check: "40%" },
                    { item: "Brakes", check: "RELEASE" },
                    { item: "Throttle", check: "FLX/MCT" }
                ]
            },
            {
                title: "After Takeoff",
                items: [
                    { item: "Gear Lever", check: "UP" },
                    { item: "Throttle", check: "CL at 200 kt" },
                    { item: "Flaps", check: "UP" },
                    { item: "AP1", check: "ON" },
                    { item: "Speed Brakes", check: "DISARM" },
                    { item: "Nose/RWY Turnoff Lights", check: "OFF" }
                ]
            },
            {
                title: "Climb",
                items: [
                    { item: "Managed/Selected Mode", check: "As required" },
                    { item: "Anti-Ice", check: "As required" },
                    { item: "QNH", check: "STD at transition" },
                    { item: "Landing Lights L/R", check: "OFF at FL100" },
                    { item: "Seatbelt Sign", check: "OFF at FL100" }
                ]
            },
            {
                title: "Cruise",
                items: [
                    { item: "ECAM Pages", check: "CHECK" }
                ]
            },
            {
                title: "Descent Prep",
                items: [
                    { item: "MCDU ‚Äì APPR Page", check: "SELECT" },
                    { item: "QNH", check: "SET" },
                    { item: "TEMP", check: "SET" },
                    { item: "MAG/WIND", check: "SET" },
                    { item: "TRANS ALT", check: "SET" },
                    { item: "VAPP & VLS", check: "CHECK" }
                ]
            },
            {
                title: "Descent",
                items: [
                    { item: "Managed/Selected Mode", check: "As required" },
                    { item: "Anti-Ice", check: "As required" },
                    { item: "Landing Lights L/R", check: "ON at FL100" },
                    { item: "Seatbelt Sign", check: "ON at FL100" },
                    { item: "QNH", check: "SET at transition" }
                ]
            },
            {
                title: "Approach",
                items: [
                    { item: "Auto Brake", check: "SET" },
                    { item: "Speed Brakes", check: "ARMED" },
                    { item: "LS", check: "ON" },
                    { item: "APPR", check: "ON (if GS available)" },
                    { item: "Flaps 1", check: "<230 kt" },
                    { item: "Flaps 2", check: "<200 kt" },
                    { item: "Gear Lever", check: "DOWN" },
                    { item: "Flaps 3", check: "<185 kt" },
                    { item: "Flaps FULL", check: "<177 kt" },
                    { item: "RWY Turnoff Lights", check: "ON" },
                    { item: "Nose Light", check: "TAXI" }
                ]
            },
            {
                title: "After Landing",
                items: [
                    { item: "Flaps", check: "UP" },
                    { item: "Speed Brakes", check: "RET/DISARM" },
                    { item: "TCAS", check: "STBY" },
                    { item: "PWS", check: "OFF" },
                    { item: "WX Radar", check: "OFF" },
                    { item: "APU Master", check: "ON" },
                    { item: "APU Start", check: "ON" },
                    { item: "Anti-Ice", check: "OFF" },
                    { item: "Nose Light", check: "TAXI" },
                    { item: "RWY Turnoff Lights", check: "ON (if req)" },
                    { item: "Landing Lights L/R", check: "RETRACT" }
                ]
            },
            {
                title: "Parking",
                items: [
                    { item: "Parking Brake", check: "SET" },
                    { item: "RWY Turnoff Lights", check: "OFF" },
                    { item: "Nose Light", check: "OFF" },
                    { item: "APU Bleed", check: "ON" },
                    { item: "ENG Master 1 & 2", check: "OFF" },
                    { item: "Beacon", check: "OFF (<5% N1)" },
                    { item: "Seatbelt Sign", check: "OFF (<5% N1)" },
                    { item: "Fuel Pumps", check: "OFF" }
                ]
            },
            {
                title: "Securing Aircraft",
                items: [
                    { item: "APU Master", check: "OFF" },
                    { item: "IRS 1, 2, 3", check: "OFF" },
                    { item: "Crew Supply", check: "OFF" },
                    { item: "APU Bleed", check: "OFF" },
                    { item: "EMER Exit Light", check: "OFF" },
                    { item: "Strobe Light", check: "OFF" },
                    { item: "NAV & LOGO Lights", check: "OFF" },
                    { item: "Battery 1 & 2", check: "OFF" }
                ]
            }
        ]

        // App State
        let currentStage = 0
        let checkedItems = {}
        let isDarkMode = localStorage.getItem('darkMode') === 'true'
        let userScrolledManually = false
        let scrollTimeout
        let autoAdvanceTimeout = null
        let countdownInterval = null

        // DOM Elements
        const stageTitle = document.getElementById('stageTitle')
        const checklistContainer = document.getElementById('checklistContainer')
        const stageComplete = document.getElementById('stageComplete')
        const prevBtn = document.getElementById('prevBtn')
        const nextBtn = document.getElementById('nextBtn')
        const stageCounter = document.getElementById('stageCounter')
        const progressBar = document.getElementById('progressBar')
        const progressText = document.getElementById('progressText')
        const themeToggle = document.getElementById('themeToggle')
        const resetAll = document.getElementById('resetAll')

        // Initialize App
        function init() {
            // Load saved state
            const savedState = localStorage.getItem('a320ChecklistState')
            if (savedState) {
                const state = JSON.parse(savedState)
                currentStage = state.currentStage || 0
                checkedItems = state.checkedItems || {}
            }

            // Set theme
            document.documentElement.classList.toggle('dark', isDarkMode)
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô'

            renderStage()
            updateNavigation()
            updateProgress()
            setupScrollDetection()
        }

        // Setup scroll detection for manual scrolling
        function setupScrollDetection() {
            let scrollTimer

            window.addEventListener('scroll', () => {
                userScrolledManually = true

                clearTimeout(scrollTimer)
                scrollTimer = setTimeout(() => {
                    userScrolledManually = false
                }, 2000) // Reset flag after 2 seconds of no scrolling
            })

            // Reset on touch start (mobile)
            window.addEventListener('touchstart', () => {
                userScrolledManually = false
            })
        }

        // Smart auto-scroll function
        function autoScrollIfNeeded() {
            // Don't auto-scroll if user manually scrolled recently
            if (userScrolledManually) return

            const viewportHeight = window.innerHeight
            const scrollTop = window.pageYOffset
            const scrollTriggerZone = viewportHeight * 0.7 // Trigger when 70% down viewport

            // Find next unchecked item
            const checklistItems = checklistContainer.children
            let nextUncheckedItem = null

            for (let i = 0; i < checklistItems.length; i++) {
                const itemIndex = parseInt(checklistItems[i].dataset.itemIndex)
                const itemId = `${currentStage}-${itemIndex}`

                if (!checkedItems[itemId]) {
                    nextUncheckedItem = checklistItems[i]
                    break
                }
            }

            if (nextUncheckedItem) {
                const itemRect = nextUncheckedItem.getBoundingClientRect()
                const itemTopInViewport = itemRect.top

                // If the next unchecked item is close to bottom or below viewport
                if (itemTopInViewport > scrollTriggerZone) {
                    const targetScrollTop = scrollTop + itemTopInViewport - (viewportHeight * 0.3)

                    window.scrollTo({
                        top: Math.max(0, targetScrollTop),
                        behavior: 'smooth'
                    })
                }
            } else {
                // All items checked, maybe scroll to completion message or navigation
                const stageCompleteElement = document.getElementById('stageComplete')
                if (stageCompleteElement && !stageCompleteElement.classList.contains('hidden')) {
                    const completeRect = stageCompleteElement.getBoundingClientRect()
                    if (completeRect.top > scrollTriggerZone) {
                        stageCompleteElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        })
                    }
                }
            }
        }

        // Render current stage
        function renderStage() {
            const stage = checklistData[currentStage]
            stageTitle.textContent = stage.title

            checklistContainer.innerHTML = ''

            stage.items.forEach((item, index) => {
                const itemId = `${currentStage}-${index}`
                const isChecked = checkedItems[itemId] || false

                const itemDiv = document.createElement('div')
                itemDiv.className = `flex items-center p-4 rounded-lg border transition-all duration-200 cursor-pointer ${isChecked
                    ? 'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700'
                    : 'bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750'
                    }`

                // Add data attribute for tracking
                itemDiv.dataset.itemIndex = index

                itemDiv.innerHTML = `
            <div class="flex items-center mr-4 flex-shrink-0">
                <input type="checkbox" ${isChecked ? 'checked' : ''} 
                       class="w-5 h-5 text-airbus-blue dark:text-cockpit-green rounded border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-airbus-blue dark:focus:ring-cockpit-green">
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                    <span class="font-medium text-gray-900 dark:text-gray-100 break-words">${item.item}</span>
                    <span class="text-sm font-mono text-airbus-blue dark:text-cockpit-green break-words sm:text-right">${item.check}</span>
                </div>
            </div>
        `

                const checkbox = itemDiv.querySelector('input[type="checkbox"]')

                itemDiv.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked
                    }
                    toggleItem(itemId, checkbox.checked)
                })

                checkbox.addEventListener('change', (e) => {
                    toggleItem(itemId, e.target.checked)
                })

                checklistContainer.appendChild(itemDiv)
            })

            checkStageCompletion()
        }

        // Toggle checklist item with auto-scroll and immediate visual update
        function toggleItem(itemId, checked) {
            checkedItems[itemId] = checked
            saveState()

            // Update visual appearance immediately
            updateItemVisualState(itemId, checked)

            checkStageCompletion()

            // Auto-scroll after a short delay to allow UI to update
            if (checked) {
                clearTimeout(scrollTimeout)
                scrollTimeout = setTimeout(() => {
                    autoScrollIfNeeded()
                }, 150)
            }
        }

        // New function to update individual item's visual state
        function updateItemVisualState(itemId, isChecked) {
            const [stageIndex, itemIndex] = itemId.split('-')
            const itemDiv = checklistContainer.children[itemIndex]

            if (itemDiv) {
                // Update the container's classes
                if (isChecked) {
                    itemDiv.className = 'flex items-center p-4 rounded-lg border transition-all duration-200 cursor-pointer bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700'
                } else {
                    itemDiv.className = 'flex items-center p-4 rounded-lg border transition-all duration-200 cursor-pointer bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-750'
                }
            }
        }

        // Check if stage is complete and handle auto-advance
        function checkStageCompletion() {
            const stage = checklistData[currentStage]
            const stageItems = stage.items.length
            let checkedCount = 0

            for (let i = 0; i < stageItems; i++) {
                const itemId = `${currentStage}-${i}`
                if (checkedItems[itemId]) checkedCount++
            }

            const isComplete = checkedCount === stageItems
            const wasCompleteAlready = !stageComplete.classList.contains('hidden')

            stageComplete.classList.toggle('hidden', !isComplete)

            if (isComplete && !wasCompleteAlready) {
                // Stage just completed - start auto-advance if not on last stage
                if (currentStage < checklistData.length - 1) {
                    startAutoAdvance()
                }

                // Auto-scroll to completion message when stage is complete
                if (!userScrolledManually) {
                    setTimeout(() => {
                        stageComplete.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        })
                    }, 300)
                }
            } else if (!isComplete) {
                // Stage no longer complete - cancel auto-advance
                cancelAutoAdvance()
            }
        }

        // Update navigation buttons
        function updateNavigation() {
            prevBtn.disabled = currentStage === 0
            nextBtn.disabled = currentStage === checklistData.length - 1
            stageCounter.textContent = `${currentStage + 1} of ${checklistData.length}`
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((currentStage + 1) / checklistData.length) * 100
            progressBar.style.width = `${progress}%`
            progressText.textContent = `${currentStage + 1}/${checklistData.length}`
        }

        // Navigate to previous stage
        function prevStage() {
            if (currentStage > 0) {
                cancelAutoAdvance() // Add this line
                currentStage--
                renderStage()
                updateNavigation()
                updateProgress()
                saveState()
                window.scrollTo(0, 0)
                userScrolledManually = false
            }
        }

        // Navigate to next stage  
        function nextStage() {
            if (currentStage < checklistData.length - 1) {
                cancelAutoAdvance() // Add this line
                currentStage++
                renderStage()
                updateNavigation()
                updateProgress()
                saveState()
                window.scrollTo(0, 0)
                userScrolledManually = false
            }
        }

        // Toggle theme
        function toggleTheme() {
            isDarkMode = !isDarkMode
            document.documentElement.classList.toggle('dark', isDarkMode)
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô'
            localStorage.setItem('darkMode', isDarkMode)
        }

        // Reset all progress
        function resetAllProgress() {
            if (confirm('Reset all checklist progress? This cannot be undone.')) {
                checkedItems = {}
                currentStage = 0
                saveState()
                renderStage()
                updateNavigation()
                updateProgress()
                window.scrollTo(0, 0)
                userScrolledManually = false
            }
        }

        // Save state to localStorage
        function saveState() {
            const state = {
                currentStage,
                checkedItems
            }
            localStorage.setItem('a320ChecklistState', JSON.stringify(state))
        }

        // Start auto-advance countdown
        function startAutoAdvance() {
            const autoAdvanceIndicator = document.getElementById('autoAdvanceIndicator')
            const countdownTimer = document.getElementById('countdownTimer')
            const cancelBtn = document.getElementById('cancelAutoAdvance')

            // Show the indicator
            autoAdvanceIndicator.classList.remove('hidden')

            let timeLeft = 2
            countdownTimer.textContent = timeLeft

            // Start countdown
            countdownInterval = setInterval(() => {
                timeLeft--
                countdownTimer.textContent = timeLeft

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval)
                    autoAdvanceIndicator.classList.add('hidden')
                    nextStage() // Move to next stage
                }
            }, 1000)

            // Set timeout as backup
            autoAdvanceTimeout = setTimeout(() => {
                autoAdvanceIndicator.classList.add('hidden')
                nextStage()
            }, 2000)
        }

        // Cancel auto-advance
        function cancelAutoAdvance() {
            const autoAdvanceIndicator = document.getElementById('autoAdvanceIndicator')

            if (autoAdvanceTimeout) {
                clearTimeout(autoAdvanceTimeout)
                autoAdvanceTimeout = null
            }

            if (countdownInterval) {
                clearInterval(countdownInterval)
                countdownInterval = null
            }

            autoAdvanceIndicator.classList.add('hidden')
        }

        // Event Listeners
        prevBtn.addEventListener('click', prevStage)
        nextBtn.addEventListener('click', nextStage)
        themeToggle.addEventListener('click', toggleTheme)
        resetAll.addEventListener('click', resetAllProgress)

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevStage()
            if (e.key === 'ArrowRight') nextStage()
            if (e.key === 'Escape') window.scrollTo(0, 0)
        })

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init)
        document.getElementById('cancelAutoAdvance').addEventListener('click', cancelAutoAdvance)
    </script>
</body>

</html>